<script>
class BattleGame {
    constructor(region, worldGame) {
        this.region = region;
        this.worldGame = worldGame;
        this.canvas = document.getElementById('battleScreen');
        this.ctx = this.canvas.getContext('2d');
        this.units = new Map();
        this.bullets = [];
        this.selectedUnits = [];
        
        this.resources = {
            gold: 1000,
            oil: 500
        };

        this.battleTime = 0; // ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
        this.enemyAggression = 0; // Ø´Ø±Ø§Ø³Ø© Ø§Ù„Ø¹Ø¯Ùˆ
    }

    start() {
        this.createInitialUnits();
        this.setupEventListeners();
        this.gameLoop();
    }

    createInitialUnits() {
        // ğŸ¯ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ - Ù†Ø²ÙŠØ¯Ù‡Ù… Ø´ÙˆÙŠØ©
        for (let i = 0; i < 5; i++) {
            this.createUnit('soldier', 100 + i * 60, 400, 'blue', true);
        }
        
        // ğŸ¯ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ø¯Ùˆ - Ù†Ø¨Ø¹Ø¯Ù‡Ù… Ø´ÙˆÙŠØ© ÙˆÙ†Ù‚Ù„Ù„ Ø¹Ø¯Ø¯Ù‡Ù…
        for (let i = 0; i < 2; i++) {
            this.createUnit('soldier', 700 + i * 80, 400, 'red', true);
        }

        // ğŸ›¡ï¸ Ù†Ø¹Ø·ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆÙ‚Øª Ù„ÙŠØªØ­Ø¶Ø±
        setTimeout(() => {
            this.startEnemyAI();
        }, 3000);
    }

    startEnemyAI() {
        // Ø§Ù„Ø¹Ø¯Ùˆ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        this.enemyAggression = 1;
    }

    updateCombat() {
        const now = Date.now();
        this.battleTime++;
        
        // ğŸ¯ Ø§Ù„Ø¹Ø¯Ùˆ ÙŠÙ‡Ø§Ø¬Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯ÙˆØ§Ù†ÙŠ
        if (this.enemyAggression > 0) {
            for (const enemy of this.units.values()) {
                if (enemy.team === 'red' && enemy.health > 0 && !enemy.isAttacking) {
                    // ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ÙˆØ­Ø¯Ø© ØµØ¯ÙŠÙ‚Ø©
                    let closestTarget = null;
                    let closestDistance = Infinity;
                    
                    for (const unit of this.units.values()) {
                        if (unit.team === 'blue' && unit.health > 0) {
                            const distance = Math.sqrt((enemy.x - unit.x) ** 2 + (enemy.y - unit.y) ** 2);
                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestTarget = unit;
                            }
                        }
                    }
                    
                    if (closestTarget && closestDistance < 200) { // Ù…Ø¯Ù‰ Ø±Ø¤ÙŠØ© Ø§Ù„Ø¹Ø¯Ùˆ
                        enemy.target = closestTarget;
                        enemy.isAttacking = true;
                    }
                }
            }
        }
        
        // ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ØªØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        for (const unit of this.units.values()) {
            if (unit.isAttacking && unit.target && unit.health > 0) {
                const target = unit.target;
                if (target.health <= 0) {
                    unit.isAttacking = false;
                    unit.target = null;
                    continue;
                }

                const distance = Math.sqrt((unit.x - target.x) ** 2 + (unit.y - target.y) ** 2);
                
                if (distance <= unit.range) {
                    if (now - unit.lastAttack >= unit.attackSpeed) {
                        target.health -= unit.attack;
                        unit.lastAttack = now;
                        
                        if (target.health <= 0) {
                            this.units.delete(target.id);
                            unit.isAttacking = false;
                            unit.target = null;
                        }
                    }
                } else {
                    // Ø§Ù„ØªØ­Ø±Ùƒ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù
                    const dx = target.x - unit.x;
                    const dy = target.y - unit.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    unit.x += (dx / dist) * Math.min(unit.speed, dist * 0.1);
                    unit.y += (dy / dist) * Math.min(unit.speed, dist * 0.1);
                }
            }
        }
    }

    checkBattleEnd() {
        let blueUnits = 0, redUnits = 0;
        
        for (const unit of this.units.values()) {
            if (unit.health > 0) {
                if (unit.team === 'blue') blueUnits++;
                else redUnits++;
            }
        }
        
        if (blueUnits === 0) {
            setTimeout(() => {
                alert('ğŸ’” Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©! ÙˆØ­Ø¯Ø§ØªÙƒ Ø¯Ù…Ø±Øª Ø¬Ù…ÙŠØ¹Ø§Ù‹!\n\nğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø­Ø§ÙˆÙ„ ØªØ¬Ù†ÙŠØ¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¬Ù†ÙˆØ¯ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙƒØªÙŠÙƒØ§Øª!');
                this.worldGame.returnToMap();
            }, 1000);
        } else if (redUnits === 0) {
            setTimeout(() => {
                alert(`ğŸ‰ Ø§Ù†ØªØµØ±Øª! ${this.region.name} Ø§Ù„Ø¢Ù† ØªØ­Øª Ø³ÙŠØ·Ø±ØªÙƒ!\n\nğŸ† +${this.region.level * 100} Ù†Ù‚Ø·Ø©`);
                this.region.owner = 'player';
                this.worldGame.returnToMap();
            }, 1000);
        }
    }

    handleClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ø¯Ø© Ù…Ù†Ù‚ÙˆØ±Ø©
        let clickedUnit = null;
        for (const unit of this.units.values()) {
            const distance = Math.sqrt((unit.x - x) ** 2 + (unit.y - y) ** 2);
            if (distance < 20) {
                clickedUnit = unit;
                break;
            }
        }
        
        if (clickedUnit) {
            if (clickedUnit.team === 'blue') {
                this.selectUnit(clickedUnit);
            } else if (this.selectedUnits.length > 0) {
                // âš”ï¸ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ùˆ
                this.selectedUnits.forEach(unit => {
                    unit.target = clickedUnit;
                    unit.isAttacking = true;
                });
            }
        } else if (this.selectedUnits.length > 0) {
            // ğŸš€ ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
            this.moveSelectedUnits(x, y);
        }
    }

    render() {
        this.ctx.fillStyle = '#1a3c2d';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ğŸ¨ Ø±Ø³Ù… Ø§Ù„Ø£Ø±Ø¶
        this.ctx.fillStyle = '#8B4513';
        this.ctx.fillRect(0, 450, this.canvas.width, 150);
        
        // ğŸ¯ Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();
        this.ctx.moveTo(this.canvas.width / 2, 0);
        this.ctx.lineTo(this.canvas.width / 2, this.canvas.height);
        this.ctx.stroke();
        
        // ğŸ¯ Ø±Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        for (const unit of this.units.values()) {
            this.drawUnit(unit);
        }
        
        // ğŸ¯ Ø±Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
        this.ctx.fillStyle = 'white';
        this.ctx.font = '16px Arial';
        this.ctx.fillText(`â° ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©: ${Math.floor(this.battleTime / 60)} Ø«Ø§Ù†ÙŠØ©`, 20, 30);
        
        let blueCount = 0, redCount = 0;
        for (const unit of this.units.values()) {
            if (unit.health > 0) {
                if (unit.team === 'blue') blueCount++;
                else redCount++;
            }
        }
        this.ctx.fillText(`ğŸ‘¤ ÙˆØ­Ø¯Ø§ØªÙƒ: ${blueCount} | ğŸ¯ Ø§Ù„Ø¹Ø¯Ùˆ: ${redCount}`, 20, 60);
    }

    drawUnit(unit) {
        this.ctx.save();
        this.ctx.translate(unit.x, unit.y);
        
        // ğŸ¨ Ù„ÙˆÙ† Ø§Ù„ÙˆØ­Ø¯Ø©
        this.ctx.fillStyle = unit.team === 'blue' ? '#3498db' : '#e74c3c';
        
        if (unit.type === 'soldier') {
            this.ctx.fillRect(-8, -12, 16, 24);
            
            // ğŸ¨ Ø±Ø£Ø³ Ø§Ù„Ø¬Ù†Ø¯ÙŠ
            this.ctx.fillStyle = unit.team === 'blue' ? '#2980b9' : '#c0392b';
            this.ctx.fillRect(-6, -16, 12, 8);
        } else if (unit.type === 'tank') {
            this.ctx.fillRect(-12, -8, 24, 16);
            this.ctx.fillStyle = unit.team === 'blue' ? '#2980b9' : '#c0392b';
            this.ctx.fillRect(-4, -16, 8, 12);
        }
        
        // ğŸ›¡ï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        if (unit.selected) {
            this.ctx.strokeStyle = '#f1c40f';
            this.ctx.lineWidth = 2;
            this.ctx.setLineDash([5, 5]);
            this.ctx.strokeRect(-15, -18, 30, 30);
            this.ctx.setLineDash([]);
        }
        
        // â¤ï¸ Ø´Ø±ÙŠØ· Ø§Ù„ØµØ­Ø©
        const healthRatio = unit.health / unit.maxHealth;
        this.ctx.fillStyle = '#e74c3c';
        this.ctx.fillRect(-15, -25, 30, 4);
        this.ctx.fillStyle = healthRatio > 0.6 ? '#2ecc71' : healthRatio > 0.3 ? '#f39c12' : '#e74c3c';
        this.ctx.fillRect(-15, -25, 30 * healthRatio, 4);
        
        this.ctx.restore();
    }

    // ğŸ¯ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ...
    updateUnit(unit) {
        if (!unit.isAttacking || !unit.target) {
            const dx = unit.targetX - unit.x;
            const dy = unit.targetY - unit.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 2) {
                unit.x += (dx / distance) * Math.min(unit.speed, distance * 0.1);
                unit.y += (dy / distance) * Math.min(unit.speed, distance * 0.1);
            }
        }
    }

    update() {
        for (const unit of this.units.values()) {
            this.updateUnit(unit);
        }
        
        this.updateCombat();
        this.checkBattleEnd();
    }

    gameLoop() {
        this.update();
        this.render();
        requestAnimationFrame(() => this.gameLoop());
    }
}
</script>
